{% extends "base.html" %}

{% block title %}股票首頁{% endblock %}
{% block header_title %}股票首頁{% endblock %}

{% block content %}
<div class="container" style="max-width:1200px; margin:30px auto; padding:20px;">
    <h1 style="text-align:center; margin-bottom:40px;">股票列表</h1>

    <div class="stock-grid" style="
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); 
        gap: 20px;">
        {% for code, name in stocks.items() %}
            <div class="stock-card" style="
                background-color: white; 
                color: black; 
                border: 1px solid #ddd; 
                border-radius: 8px; 
                overflow: hidden; 
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); 
                display: flex; 
                flex-direction: column;">

                <!-- 標題 + 搜尋 -->
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding:10px 16px;">
                    <a id="title-{{ code }}" href="{{ url_for('stock.stock_detail', stock_code=code) }}" 
                       style="text-decoration: none; color: #333; font-weight: bold; font-size: 18px;">
                        {{ name }}（{{ code }}）
                    </a>
                    <div>
                        <input type="text" id="search-{{ code }}" placeholder="輸入代碼" style="width:90px; padding:2px 5px; font-size:14px;">
                        <button onclick="updateKline('{{ code }}')" style="padding:2px 6px; font-size:14px;">搜尋</button>
                    </div>
                </div>

                <!-- K 線圖 -->
                <div id="kline-{{ code }}" style="width:100%; height:250px;"></div>
            </div>
        {% endfor %}
    </div>
</div>

<!-- Plotly -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
    // 繪製 K 線圖函式
    async function drawKline(stockCode, targetDiv, titleId=null) {
        try {
            const res = await fetch(`/stock/kline/${stockCode}`);
            if (!res.ok) {
                console.error('Fetch failed for', stockCode, res.status);
                return;
            }
            const result = await res.json();

            if (!result || !result.kline || result.kline.length === 0) {
                document.getElementById(targetDiv).innerHTML =
                  "<p style='color:red;text-align:center;'>查無K線資料</p>";
                return;
            }

           // 更新標題文字和連結（用傳入的 stockCode，不依賴 result.code）
	   if (titleId && result.name) {
  	    const titleEl = document.getElementById(titleId);
 	    titleEl.textContent = `${result.name}（${stockCode}）`;
  	    titleEl.href = `/stock/detail/${encodeURIComponent(stockCode)}`;
}
            // 畫圖
            const data = result.kline;
            const trace = {
                x: data.map(d => d.date),
                open: data.map(d => d.open),
                high: data.map(d => d.high),
                low: data.map(d => d.low),
                close: data.map(d => d.close),
                type: 'candlestick',
                increasing: { line: { color: 'green' } },
                decreasing: { line: { color: 'red' } }
            };

            const layout = {
                margin: { t: 20, b: 30 },
                xaxis: { rangeslider: { visible: false } },
                yaxis: { autorange: true }
            };

            Plotly.newPlot(targetDiv, [trace], layout, { displayModeBar: false });
        } catch (err) {
            console.error('Error drawing Kline for', stockCode, err);
        }
    }

    // 初始繪製
    {% for code, name in stocks.items() %}
    drawKline('{{ code }}', 'kline-{{ code }}', 'title-{{ code }}');
    {% endfor %}

    // 更新指定卡片的 K 線圖 + 標題
    function updateKline(originalCode) {
        const input = document.getElementById(`search-${originalCode}`);
        const newCode = input.value.trim();
        if (!newCode) return;

        drawKline(newCode, `kline-${originalCode}`, `title-${originalCode}`);
    }
</script>

{% endblock %}